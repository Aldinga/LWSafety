<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lone Worker System Setup Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .step { display: none; }
        .step.active { display: block; }
        .tab { padding: 0.5rem 1rem; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { border-color: #3b82f6; color: #3b82f6; }
        .loader { border: 4px solid #f3f4f6; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-xl overflow-hidden">
        <header class="bg-gray-800 text-white p-6">
            <h1 class="text-3xl font-bold">Lone Worker Safety System - Setup Tool</h1>
            <p class="text-gray-300 mt-1">Generate your customized, self-hosted safety apps.</p>
        </header>

        <div class="p-6 md:p-8">
            <nav class="flex border-b mb-6">
                <button class="tab active" data-step="1">Step 1: Backend</button>
                <button class="tab" data-step="2">Step 2: Customize</button>
                <button class="tab" data-step="3">Step 3: Generate</button>
            </nav>

            <div id="step1" class="step active">
                <h2 class="text-2xl font-semibold text-blue-600 mb-4">Step 1: Deploy the Google Apps Script Backend</h2>
                <p class="mb-4">This script is the "brain" of your system. You must deploy it as a Web App from a Google Sheet.</p>
                <ol class="list-decimal list-inside space-y-3 text-gray-700">
                    <li>Create a new Google Sheet in your Google account. Name it "LoneWorkerDatabase".</li>
                    <li>Go to <strong>Extensions &gt; Apps Script</strong>.</li>
                    <li>Delete any code in the `Code.gs` file and paste the entire script below into the editor.
                        <button id="copyScriptBtn" class="ml-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-1 px-3 rounded-lg">Copy Script Code</button>
                    </li>
                    <li>
                        <strong>Crucial:</strong> Find the line `var SECRET_KEY = "YOUR_SECRET_KEY_HERE";` near the top.
                        <br>Change `"YOUR_SECRET_KEY_HERE"` to a strong, unique password.
                        <br>Enter that *exact same* secret key here:
                        <input type="password" id="secretKey" placeholder="Enter your secret key" class="mt-1 block w-full md:w-1/2 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </li>
                    <li>Click the <strong>Save project</strong> icon (floppy disk).</li>
                    <li>Click the blue <strong>Deploy</strong> button in the top-right corner.
                    <li>Select <strong>New deployment</strong>.</li>
                    <li>For "Select type", click the gear icon and select <strong>Web app</strong>.</li>
                    <li>In the "New deployment" dialog:
                        <ul class="list-disc list-inside ml-6 mt-2">
                            <li>Enter a description, e.g., "Lone Worker v1".</li>
                            <li>For "Execute as", select <strong>Me (your email)</strong>.</li>
                            <li>For "Who has access", select <strong>Anyone</strong>. (This is required for the app to send data).</li>
                        </ul>
                    </li>
                    <li>Click <strong>Deploy</strong>.</li>
                    <li>Google will ask you to <strong>Authorize access</strong>. Follow the prompts.
                        <br>(You may see a warning screen. Click "Advanced", then "Go to [your project name] (unsafe)".)
                    </li>
                    <li>Once deployed, copy the <strong>Web app URL</strong> and paste it here:
                        <input type="url" id="scriptUrl" placeholder="Paste Web app URL here" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </li>
                    <li>Return to your Google Sheet. Add the following headers in the first row (A1 to N1):
                        <div class="mt-2 p-3 bg-gray-50 rounded-md font-mono text-sm overflow-x-auto">
                            Date | Worker Name | Worker Phone Number | Location Name | Location Address | Arrival Time | Anticipated Departure Time | Actual Departure Time | Alarm Status | Notes | Last Known GPS | GPS Timestamp | Emergency Contact Name | Emergency Contact Number | Emergency Contact Email | Escalation Contact Name | Escalation Contact Number | Escalation Contact Email
                        </div>
                        <button id="copyHeadersBtn" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-1 px-3 rounded-lg">Copy Headers</button>
                    </li>
                    <li>Set up the automated timer:
                        <ul class="list-disc list-inside ml-6 mt-2">
                            <li>In the Apps Script editor, click the <strong>Triggers</strong> icon (alarm clock) on the left.</li>
                            <li>Click <strong>Add Trigger</strong> in the bottom-right.</li>
                            <li>Set up the trigger as follows:
                                <ul class="list-disc list-inside ml-6 mt-2">
                                    <li>Function to run: <strong>checkOverdueWorkers</strong></li>
                                    <li>Deployment: <strong>Head</strong></li>
                                    <li>Event source: <strong>Time-driven</strong></li>
                                    <li>Type of time based trigger: <strong>Minutes timer</strong></li>
                                    <li>Select minute interval: <strong>Every 5 minutes</strong></li>
                                </ul>
                            </li>
                            <li>Click <strong>Save</strong>.</li>
                        </ul>
                    </li>
                </ol>
                <button id="nextToStep2" class="mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Next: Customize Apps</button>
            </div>

            <div id="step2" class="step">
                <h2 class="text-2xl font-semibold text-blue-600 mb-4">Step 2: Customize Your Apps</h2>
                <p class="mb-4">These settings will be embedded into your apps.</p>
                
                <div class="space-y-4">
                    <div>
                        <label for="firstAlertTime" class="block text-sm font-medium text-gray-700">First Email Alert Time (in minutes after overdue)</label>
                        <input type="number" id="firstAlertTime" value="15" class="mt-1 block w-48 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-sm text-gray-500 mt-1">This must match the `checkOverdueWorkers` function. Default is 15.</p>
                    </div>
                    
                    <div>
                        <label for="checkinEnabled" class="flex items-center">
                            <input type="checkbox" id="checkinEnabled" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <span class="ml-2 text-sm font-medium text-gray-700">Enable "Are You OK?" Check-ins (Optional)</span>
                        </label>
                    </div>

                    <div id="checkinOptions" class="hidden ml-6 space-y-4 p-4 bg-gray-50 rounded-md">
                        <div>
                            <label for="checkinInterval" class="block text-sm font-medium text-gray-700">Check-in Interval (in minutes)</label>
                            <input type="number" id="checkinInterval" value="30" class="mt-1 block w-48 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-sm text-gray-500 mt-1">How often should the app ask the worker "Are you OK?".</p>
                        </div>
                    </div>

                    <div>
                        <label for="dbSizeWarning" class="block text-sm font-medium text-gray-700">Database Size Warning (Monitor App)</label>
                        <input type="number" id="dbSizeWarning" value="2500" class="mt-1 block w-48 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-sm text-gray-500 mt-1">Show a warning in the monitor app when rows exceed this number.</p>
                    </div>

                    <div>
                        <label for="appIconUrl" class="block text-sm font-medium text-gray-700">App Icon URL (192x192 PNG)</label>
                        <input type="url" id="appIconUrl" value="https://i.postimg.cc/dVmVg3Pn/favicon-logo-for-LWSApp.png" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-sm text-gray-500 mt-1">Logo for the PWA. Must be a secure (https://) URL. You can upload one to <a href="https://postimages.org/" target="_blank" class="text-blue-600">postimages.org</a>.</p>
                    </div>

                    <div>
                        <label for="appName" class="block text-sm font-medium text-gray-700">App Name (PWA)</label>
                        <input type="text" id="appName" value="LWS App" class="mt-1 block w-full md:w-1/2 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <button id="nextToStep3" class="mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Next: Generate Package</button>
            </div>

            <div id="step3" class="step">
                <h2 class="text-2xl font-semibold text-blue-600 mb-4">Step 3: Test and Generate</h2>
                <p class="mb-4">First, let's test the connection to your deployed script.</p>

                <div id="testConnectionArea">
                    <button id="testConnectionBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Test Connection</button>
                    <div id="testStatus" class="mt-4 hidden"></div>
                </div>

                <div id="generateArea" class="hidden mt-6">
                    <h3 class="text-xl font-semibold text-green-700">Test Successful!</h3>
                    <p class="mb-4">Your connection is working. You can now generate your final deployment package.</p>
                    <button id="generateZipBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg">
                        <span id="generateText">Generate .zip Package</span>
                        <div id="generateLoader" class="loader hidden"></div>
                    </button>
                    <p class="text-sm text-gray-500 mt-2">This will download a .zip file containing all the documentation and app folders.</p>
                </div>
            </div>
        </div>
    </div>

    <script type="text/template" id="template-worker-app">
    </script>
    <script type="text/template" id="template-monitor-app">
    </script>
    <script type="text/template" id="template-apps-script">
    </script>

    <script>
        // Store template content in JS variables
        const workerAppTemplate = `{{WORKER_APP_TEMPLATE_CONTENT}}`;
        const monitorAppTemplate = `{{MONITOR_APP_TEMPLATE_CONTENT}}`;
        const appsScriptTemplate = `{{APPS_SCRIPT_TEMPLATE_CONTENT}}`;

        // Fill the textareas in the HTML (for display/copy)
        document.getElementById('template-worker-app').textContent = workerAppTemplate;
        document.getElementById('template-monitor-app').textContent = monitorAppTemplate;
        document.getElementById('template-apps-script').textContent = appsScriptTemplate;

        // App Logic
        const tabs = document.querySelectorAll('.tab');
        const steps = document.querySelectorAll('.step');
        const nextToStep2 = document.getElementById('nextToStep2');
        const nextToStep3 = document.getElementById('nextToStep3');
        const checkinEnabled = document.getElementById('checkinEnabled');
        const checkinOptions = document.getElementById('checkinOptions');
        const testConnectionBtn = document.getElementById('testConnectionBtn');
        const testStatus = document.getElementById('testStatus');
        const generateArea = document.getElementById('generateArea');
        const generateZipBtn = document.getElementById('generateZipBtn');
        const copyScriptBtn = document.getElementById('copyScriptBtn');
        const copyHeadersBtn = document.getElementById('copyHeadersBtn');

        function navigateToStep(stepNum) {
            steps.forEach(s => s.classList.remove('active'));
            tabs.forEach(t => t.classList.remove('active'));
            document.getElementById(`step${stepNum}`).classList.add('active');
            document.querySelector(`.tab[data-step="${stepNum}"]`).classList.add('active');
        }

        tabs.forEach(tab => {
            tab.addEventListener('click', (e) => navigateToStep(e.target.dataset.step));
        });

        nextToStep2.addEventListener('click', () => {
            const url = document.getElementById('scriptUrl').value;
            const key = document.getElementById('secretKey').value;
            if (!url || !key) {
                alert('Please provide both the Web App URL and the Secret Key from Step 1.');
                return;
            }
            navigateToStep(2);
        });

        nextToStep3.addEventListener('click', () => navigateToStep(3));

        checkinEnabled.addEventListener('change', () => {
            checkinOptions.classList.toggle('hidden', !checkinEnabled.checked);
        });

        copyScriptBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(appsScriptTemplate).then(() => {
                copyScriptBtn.textContent = 'Copied!';
                setTimeout(() => { copyScriptBtn.textContent = 'Copy Script Code'; }, 2000);
            });
        });

        copyHeadersBtn.addEventListener('click', () => {
            const headers = "Date\tWorker Name\tWorker Phone Number\tLocation Name\tLocation Address\tArrival Time\tAnticipated Departure Time\tActual Departure Time\tAlarm Status\tNotes\tLast Known GPS\tGPS Timestamp\tEmergency Contact Name\tEmergency Contact Number\tEmergency Contact Email\tEscalation Contact Name\tEscalation Contact Number\tEscalation Contact Email";
            navigator.clipboard.writeText(headers).then(() => {
                copyHeadersBtn.textContent = 'Copied!';
                setTimeout(() => { copyHeadersBtn.textContent = 'Copy Headers'; }, 2000);
            });
        });

        testConnectionBtn.addEventListener('click', () => {
            const url = document.getElementById('scriptUrl').value;
            const key = document.getElementById('secretKey').value;
            if (!url || !key) {
                alert('Please go back to Step 1 and provide the URL and Secret Key.');
                return;
            }

            testStatus.classList.remove('hidden', 'text-green-700', 'text-red-700');
            testStatus.innerHTML = '<div class="loader inline-block mr-2"></div> Testing...';
            
            const callbackName = 'jsonp_test_' + Date.now();
            const script = document.createElement('script');
            let timer = setTimeout(() => {
                handleError("Test failed: Timed out. Check the URL and ensure the script is deployed correctly.");
            }, 10000);

            const handleError = (message) => {
                clearTimeout(timer);
                delete window[callbackName];
                if (script.parentNode) script.parentNode.removeChild(script);
                testStatus.classList.add('text-red-700');
                testStatus.innerHTML = `<strong>Error:</strong> ${message}`;
                generateArea.classList.add('hidden');
            };

            window[callbackName] = (data) => {
                clearTimeout(timer);
                delete window[callbackName];
                if (script.parentNode) script.parentNode.removeChild(script);

                if (data && data.status === 'error' && data.message.includes('Access Denied')) {
                    testStatus.classList.add('text-red-700');
                    testStatus.innerHTML = '<strong>Test Failed:</strong> Access Denied. The Secret Key is incorrect.';
                } else if (data && Array.isArray(data)) {
                    testStatus.classList.add('text-green-700');
                    testStatus.innerHTML = '<strong>Test Successful!</strong> Received data from the Google Sheet.';
                    generateArea.classList.remove('hidden');
                } else {
                    handleError("Test failed: Received an unexpected response. Check the script.");
                }
            };

            script.onerror = () => handleError("Test failed: Could not load the script. Check the Web App URL and CORS settings (though JSONP should bypass this).");
            script.src = `${url}?callback=${callbackName}&token=${encodeURIComponent(key)}`;
            document.body.appendChild(script);
        });

        generateZipBtn.addEventListener('click', async () => {
            document.getElementById('generateText').classList.add('hidden');
            document.getElementById('generateLoader').classList.remove('hidden');
            generateZipBtn.disabled = true;

            try {
                const zip = new JSZip();

                // 1. Get customizations
                const scriptUrl = document.getElementById('scriptUrl').value;
                const secretKey = document.getElementById('secretKey').value;
                const firstAlertTime = document.getElementById('firstAlertTime').value;
                const isCheckinEnabled = document.getElementById('checkinEnabled').checked;
                const checkinInterval = document.getElementById('checkinInterval').value;
                const dbSizeWarning = document.getElementById('dbSizeWarning').value;
                const appIconUrl = document.getElementById('appIconUrl').value;
                const appName = document.getElementById('appName').value;
                
                // 2. Create Documentation
                zip.file("Administrator_Setup_Guide.md", createAdminGuide());
                zip.file("Installer_Creation_Guide.md", createInstallerGuide());
                zip.file("Promotional_Blurb.md", createPromoBlurb());

                // 3. Create Backend Folder
                const backendFolder = zip.folder("Backend_Script");
                let processedScript = appsScriptTemplate.replace(
                    'var SECRET_KEY = "YOUR_SECRET_KEY_HERE";',
                    `var SECRET_KEY = "${secretKey}";`
                );
                backendFolder.file("apps_script_code.txt", processedScript);

                // 4. Create Worker App
                const workerAppFolder = zip.folder("LoneWorkerApp");
                let processedWorkerApp = workerAppTemplate
                    .replace(
                        'const FIRST_ALERT_MINUTES = 15;',
                        `const FIRST_ALERT_MINUTES = ${firstAlertTime};`
                    )
                    .replace(
                        'const CHECKIN_ENABLED = false;',
                        `const CHECKIN_ENABLED = ${isCheckinEnabled};`
                    )
                    .replace(
                        'const CHECKIN_INTERVAL = 30;',
                        `const CHECKIN_INTERVAL = ${checkinInterval};`
                    )
                    .replace(
                        '<link rel="manifest" href="manifest.json">',
                        '<link rel="manifest" href="manifest.webmanifest">'
                    );
                
                workerAppFolder.file("index.html", processedWorkerApp);
                workerAppFolder.file("sw.js", createServiceWorker());
                workerAppFolder.file("manifest.webmanifest", createManifest(appName, appIconUrl));

                // 5. Create Monitor App
                const monitorAppFolder = zip.folder("MonitoringDashboardApp");
                let processedMonitorApp = monitorAppTemplate
                    .replace(
                        'id="googleSheetUrl" class="block w-full bg-gray-700 border',
                        `id="googleSheetUrl" value="${scriptUrl}" class="block w-full bg-gray-700 border`
                    )
                    .replace(
                        'id="secretKey" class="block w-full bg-gray-700 border',
                        `id="secretKey" value="${secretKey}" class="block w-full bg-gray-700 border`
                    )
                    .replace(
                        'if (data.length >= 2500) {',
                        `if (data.length >= ${dbSizeWarning}) {`
                    )
                    .replace(
                        '<p><strong>Warning:</strong> The database exceeds 2,500 rows. Please advise the administrator to trim the database for optimal performance.</p>',
                        `<p><strong>Warning:</strong> The database exceeds ${dbSizeWarning} rows. Please advise the administrator to trim the database for optimal performance.</p>`
                    );
                monitorAppFolder.file("index.html", processedMonitorApp);

                // 6. Generate ZIP
                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, "LoneWorkerSystem_DeploymentPackage.zip");

            } catch (err) {
                console.error(err);
                alert("Error generating .zip file: " + err.message);
            } finally {
                document.getElementById('generateText').classList.remove('hidden');
                document.getElementById('generateLoader').classList.add('hidden');
                generateZipBtn.disabled = false;
            }
        });

        // --- Helper functions for file generation ---

        function createAdminGuide() {
            return `
# Administrator Setup Guide: Lone Worker Safety System

This guide walks you through deploying your self-hosted Lone Worker Safety System.

## Before You Start

You will need:
* A Google Account (e.g., a free Gmail account or a Google Workspace account).
* The `LoneWorkerSystem_DeploymentPackage.zip` file you just generated.

## Deployment Steps

This system has three parts:
1.  **The Backend:** A Google Sheet and Google Apps Script that runs the logic.
2.  **The Worker App:** A PWA (web app) for the worker's phone.
3.  **The Monitor App:** A web-based dashboard for the person monitoring.

---

### Part 1: Deploy the Backend Script (10 Mins)

This is the most important part.

1.  **Create Google Sheet:**
    * Go to [sheets.new](https://sheets.new) to create a new, blank spreadsheet.
    * Name it something clear, like **"LoneWorkerDatabase"**.

2.  **Add Headers:**
    * In the first row (A1, B1, C1, etc.), you *must* add the correct headers.
    * The required headers are:
    `Date`, `Worker Name`, `Worker Phone Number`, `Location Name`, `Location Address`, `Arrival Time`, `Anticipated Departure Time`, `Actual Departure Time`, `Alarm Status`, `Notes`, `Last Known GPS`, `GPS Timestamp`, `Emergency Contact Name`, `Emergency Contact Number`, `Emergency Contact Email`, `Escalation Contact Name`, `Escalation Contact Number`, `Escalation Contact Email`
    * An easy way to do this is to paste the headers from the `setup.html` tool.

3.  **Open Apps Script:**
    * In your Google Sheet, click **Extensions > Apps Script**. A new tab will open for the script editor.

4.  **Paste the Code:**
    * Delete any sample code in the `Code.gs` file.
    * Open the `apps_script_code.txt` file (from the `Backend_Script` folder in your .zip package).
    * Copy the *entire contents* of this file and paste it into the Apps Script editor.

5.  **Save and Deploy:**
    * Click the **Save project** icon (floppy disk).
    * In the top-right corner, click the blue **Deploy** button and select **New deployment**.
    * A dialog box will appear. Click the **gear icon** ("Select type") and choose **Web app**.

6.  **Configure Web App:**
    * Fill in the fields *exactly* as follows:
        * **Description:** `Lone Worker System v1` (or similar).
        * **Execute as:** `Me (your email)`.
        * **Who has access:** `Anyone`.
    * **Crucial:** "Who has access" *must* be set to `Anyone` so the worker apps can send data. The `SECRET_KEY` you embedded keeps it secure.

7.  **Authorize and Finish:**
    * Click **Deploy**.
    * Google will ask you to **Authorize access**. Click the button.
    * Choose your Google account.
    * You will likely see a warning screen: "Google hasn't verified this app". This is normal.
    * Click **Advanced**, then click **"Go to [your project name] (unsafe)"**.
    * Review the permissions and click **Allow**.
    * **You are done!** The dialog will show a **Web app URL**. This URL is already embedded in your app files, so you don't need to copy it.

8.  **Set Up the Automated Timer (Final Step):**
    * In the Apps Script editor, click the **Triggers** icon (looks like an alarm clock) on the left-hand menu.
    * Click the **+ Add Trigger** button in the bottom-right.
    * Set up the trigger with these exact settings:
        * Choose which function to run: **checkOverdueWorkers**
        * Choose which deployment should run: **Head**
        * Select event source: **Time-driven**
        * Select type of time based trigger: **Minutes timer**
        * Select minute interval: **Every 5 minutes**
    * Click **Save**. You may be asked to authorize again.

**Your backend is now live and monitoring!**

---

### Part 2: Host the Web Apps

Your .zip package contains two folders: `LoneWorkerApp` and `MonitoringDashboardApp`. You need to put these "on the internet" so people can access them.

You need a simple web host. **[Netlify Drop](https://app.netlify.com/drop)** is a free and extremely easy option.

1.  **Host the Worker App:**
    * Drag the **ENTIRE `LoneWorkerApp` folder** (not the .zip) onto the Netlify Drop website.
    * Netlify will upload the files and give you a free, random URL (e.g., `https://dreamy-biscotti-12345.netlify.app`).
    * This is the link you will send to your lone workers.
    * **Recommended:** You can (and should) rename this in the Netlify settings to something more professional, like `https://mycompany-safety.netlify.app`.

2.  **Host the Monitor App:**
    * Drag the **ENTIRE `MonitoringDashboardApp` folder** onto the Netlify Drop website.
    * Netlify will give you a second, different URL.
    * This is the link for your safety monitor. **Keep this link confidential.**

---

### Part 3: Distribute to Users

1.  **For Workers:**
    * Send them the URL for your hosted **Worker App**.
    * Instruct them to open it on their phone's browser (Safari on iPhone, Chrome on Android).
    * They MUST follow the in-app instructions to **"Add to Home Screen"**. This installs it as a PWA and is required for GPS and alerts to work best.
    * The first time they open the app, they must go to **Settings** and fill in all their details (Name, Contacts, PINs, etc.).

2.  **For Monitors:**
    * Send them the URL for your hosted **Monitor App**.
    * They can open this in a web browser on a computer or tablet.
    * The App URL and Secret Key are already pre-filled. They just need to click "Start Monitoring".

Your system is now fully deployed.
`;
        }

        function createInstallerGuide() {
            return `
# Optional Guide: Creating a Desktop Installer for the Monitor App

For a more professional feel, you can package the **Monitoring Dashboard** as a simple, installable desktop app for Windows, Mac, and Linux. This makes it feel like a "real" program rather than just a website.

We will use a free tool called **[Nativefier](https://github.com/nativefier/nativefier)** to do this.

### Prerequisites

You must have [Node.js](https://nodejs.org/) installed on your computer.

### Installation

1.  Open a Terminal or Command Prompt.
2.  Install Nativefier globally by running this command:
    \`\`\`
    npm install -g nativefier
    \`\`\`

### How to Create the Installer

1.  First, deploy your \`MonitoringDashboardApp\` to a web host (like Netlify, as described in the Admin Guide).
2.  Get your final, public URL (e.g., \`https://mycompany-monitor.netlify.app\`).
3.  Open your Terminal or Command Prompt.
4.  Run the following command, replacing the URL with your own:

    \`\`\`
    nativefier "https://mycompany-monitor.netlify.app" --name "LWS Monitor" --internal-urls ".*"
    \`\`\`

### Command Breakdown

* \`nativefier\`: The command to run the tool.
* \`"https://mycompany-monitor.netlify.app"\`: The URL of your hosted monitor app.
* \`--name "LWS Monitor"\`: The name of your application.
* \`--internal-urls ".*"\`: **This is important.** It ensures that any links clicked inside the app (like Google Maps links) open in the user's *default browser* (like Chrome) instead of inside the small app window.

Nativefier will work for a minute and then create a folder (e.g., \`LWS Monitor-win32-x64\`) containing the \`.exe\` file (on Windows) or \`.app\` file (on Mac).

You can zip this folder and send it to your safety monitor to install.
`;
        }

        function createPromoBlurb() {
            return `
# Promotional Blurb: Free Lone Worker Safety System

**Headline:** Protect Your Lone Workers with a Free, Secure, Self-Hosted Safety System

**Body:**

Ensure the safety and well-being of your staff in the community with our Lone Worker Safety Systemâ€”a 100% free, open-source solution you host yourself.

Designed for non-profits, small businesses, and community organizations, this system provides robust protection without the high monthly subscription fees of commercial services. You control your data, and you pay nothing.

The system runs using a Google Sheet as a secure backend, with a simple web app for workers and a real-time dashboard for monitors.

**Core Features:**

* **Visit Timers:** Workers set their location and expected visit duration.
* **Automatic Overdue Alerts:** If a worker doesn't "depart" on time, the system automatically sends escalating email alerts to emergency contacts.
* **Instant Panic Button (SOS):** A simple triple-tap on the worker's app sends an immediate, high-priority panic alert.
* **Silent Duress PIN:** If a worker is forced to disable an alarm, they can enter a secret "duress" PIN. The app appears to shut down, but silently sends a top-priority alert to the monitor.
* **Live Monitoring Dashboard:** A web-based dashboard shows the real-time status of all active workers, with flashing visual and audible alarms for alerts.
* **GPS & Location Data:** Alerts include the worker's last known GPS coordinates or a link to the visit address on Google Maps.
* **100% Free & Self-Hosted:** No fees, ever. The system runs on your own Google account.
* **Easy to Deploy:** A simple setup tool generates all the files you need to host the system on a free service like Netlify.
`;
        }

        function createServiceWorker() {
            return `
const CACHE_NAME = 'lws-app-v1';
const URLS_TO_CACHE = [
  './',
  './index.html',
  'https://cdn.tailwindcss.com',
  'https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js',
  'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap'
];

self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then((cache) => {
        console.log('Opened cache');
        return cache.addAll(URLS_TO_CACHE);
      })
  );
  self.skipWaiting();
});

self.addEventListener('fetch', (event) => {
  event.respondWith(
    caches.match(event.request)
      .then((response) => {
        if (response) {
          return response; // Serve from cache
        }
        return fetch(event.request).catch(() => {
          // Basic fallback for offline
          return caches.match('./index.html');
        });
      })
  );
});

self.addEventListener('activate', (event) => {
  const cacheWhitelist = [CACHE_NAME];
  event.waitUntil(
    caches.keys().then((cacheNames) => {
      return Promise.all(
        cacheNames.map((cacheName) => {
          if (cacheWhitelist.indexOf(cacheName) === -1) {
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
  return self.clients.claim();
});
`;
        }

        function createManifest(appName, appIconUrl) {
            return JSON.stringify({
                "name": appName,
                "short_name": appName,
                "start_url": "./index.html",
                "display": "standalone",
                "background_color": "#111827",
                "theme_color": "#111827",
                "description": "Lone Worker Safety Application",
                "icons": [
                    {
                        "src": appIconUrl,
                        "sizes": "192x192",
                        "type": "image/png"
                    },
                    {
                        "src": appIconUrl.replace('192x192', '512x512'), // Assumes similar URL structure
                        "sizes": "512x512",
                        "type": "image/png"
                    }
                ]
            }, null, 2);
        }

    </script>
</body>
</html>
